import { Meta, Canvas, ArgTypes } from '@storybook/addon-docs/blocks'
import { A11yReport } from '@docs/helpers/A11yReport'
import { AriaRoles } from '@docs/helpers/AriaRoles'
import { Callout } from '@docs/helpers/Callout'
import { Kbd } from '../kbd'
import { FileUpload } from '.'

import * as stories from './FileUpload.stories'

<Meta of={stories} />

# FileUpload

A file upload component that provides a flexible way to handle file selection, drag-and-drop functionality, and file previews. The component supports both simple button triggers and dropzone interfaces with customizable file rendering.
<Canvas of={stories.Default} />

## Install

```sh
npm install @spark-ui/components
```

## Anatomy

```tsx
import { FileUpload } from "@spark-ui/components/file-upload"

export default () => (
  <FileUpload>
    <FileUpload.Trigger>
      Upload Files
    </FileUpload.Trigger>
    <FileUpload.Context>
      {({ acceptedFiles }) => (
        <ul>
          {acceptedFiles.map((file, index) => (
            <FileUpload.AcceptedFile key={index} file={file} />
          ))}
        </ul>
      )}
    </FileUpload.Context>
  </FileUpload>
);
```

## Callbacks

The FileUpload component provides several callback props that allow you to respond to file selection and validation events:

- **`onFileAccept`** - Called when files are accepted after validation. Receives details about the accepted files.
  ```tsx
  onFileAccept?: (details: FileAcceptDetails) => void
  
  interface FileAcceptDetails {
    files: File[]
  }
  ```

- **`onFileReject`** - Called when files are rejected due to validation errors. Receives details about the rejected files and their error codes.
  ```tsx
  onFileReject?: (details: FileRejectDetails) => void
  
  interface FileRejectDetails {
    files: RejectedFile[]
  }
  ```

- **`onFileChange`** - Called when files change (both accepted and rejected). Receives details about both accepted and rejected files. Use this for controlled mode by extracting `details.acceptedFiles` to update the `value` prop.
  ```tsx
  onFileChange?: (details: FileChangeDetails) => void
  
  interface FileChangeDetails {
    acceptedFiles: File[]
    rejectedFiles: RejectedFile[]
  }
  ```

## API Reference

### FileUpload

Contains all the parts of a file upload.

<ArgTypes of={FileUpload} />

### _.Trigger

Triggers the file selection dialog when clicked. Can be styled as a button or rendered as any component using the `render` prop.

<ArgTypes of={FileUpload.Trigger} />

### _.Dropzone

Provides a drag-and-drop area for file selection. Can be customized with children and supports the `unstyled` prop to remove default styling.

<ArgTypes of={FileUpload.Dropzone} />

### _.Context

A render prop component that provides access to the FileUpload internal state and utilities. Use this component when you need to build custom file previews or access file data programmatically.

The component uses a render prop pattern, where you pass a function as children that receives the context data:

```tsx
<FileUpload.Context>
  {({ acceptedFiles, rejectedFiles, formatFileSize, locale }) => {
    // Your custom rendering logic
  }}
</FileUpload.Context>
```

#### Exposed Data

The render prop function receives an object with the following properties:

- **`acceptedFiles`** - `File[]`  
  An array of files that have passed validation and were accepted. Each item is a native `File` object with properties like `name`, `size`, `type`, etc.

- **`rejectedFiles`** - `RejectedFile[]`  
  An array of files that were rejected during validation. Each rejected file contains:
  - `file`: `File` - The rejected file object
  - `errors`: `FileUploadFileError[]` - An array of error codes indicating why the file was rejected. Possible error codes:
    - `TOO_MANY_FILES` - Exceeds the `maxFiles` limit
    - `FILE_INVALID_TYPE` - File type not in the `accept` list
    - `FILE_TOO_LARGE` - File size exceeds `maxFileSize`
    - `FILE_TOO_SMALL` - File size below `minFileSize`
    - `FILE_INVALID` - Generic validation failure
    - `FILE_EXISTS` - Duplicate file detected
  
  You can use the `FILE_UPLOAD_ERRORS` constant object to reference these error codes instead of using string literals.

- **`formatFileSize`** - `(bytes: number, locale?: string) => string`  
  A utility function to format file sizes in bytes to a human-readable format. The function uses `Intl.NumberFormat` to format sizes according to the locale, supporting units from bytes to gigabytes.
  
  **Parameters:**
  - `bytes`: The file size in bytes
  - `locale` (optional): A [BCP47](https://www.ietf.org/rfc/bcp/bcp47.txt) language code (e.g., `'en'`, `'fr'`). If not provided, uses the locale from the FileUpload component.
  
  **Returns:** A formatted string with the appropriate unit (e.g., `"1.5 MB"`, `"1,5 Mo"`).
  
  **Examples:**
  ```tsx
  formatFileSize(1024)           // "1 kB" (or "1 ko" in French)
  formatFileSize(1024 * 1024)    // "1 MB" (or "1 Mo" in French)
  formatFileSize(1536, 'en')     // "1.5 kB"
  formatFileSize(1536, 'fr')     // "1,5 ko"
  ```

- **`locale`** - `string`  
  The [BCP47](https://www.ietf.org/rfc/bcp/bcp47.txt) language code used for formatting file sizes and error messages. This value comes from the `locale` prop of the FileUpload component, or defaults to the browser locale (or `'en'` if not available).

#### Usage Example

```tsx
<FileUpload>
  <FileUpload.Trigger>Upload Files</FileUpload.Trigger>
  <FileUpload.Context>
    {({ acceptedFiles, rejectedFiles, formatFileSize, locale }) => (
      <div>
        {acceptedFiles.length > 0 && (
          <ul>
            {acceptedFiles.map((file, index) => (
              <li key={index}>
                {file.name} - {formatFileSize(file.size, locale)}
              </li>
            ))}
          </ul>
        )}
        {rejectedFiles.length > 0 && (
          <div>
            <p>Rejected files:</p>
            {rejectedFiles.map((rejected, index) => (
              <div key={index}>
                {rejected.file.name}: {rejected.errors.join(', ')}
              </div>
            ))}
          </div>
        )}
      </div>
    )}
  </FileUpload.Context>
</FileUpload>
```

<ArgTypes of={FileUpload.Context} />

### _.AcceptedFile

Displays an accepted file with its name, size, and a delete button. Supports upload progress display via the `uploadProgress` prop.

<ArgTypes of={FileUpload.AcceptedFile} />

### _.RejectedFile

Displays a rejected file with its name, size, error messages, and a delete button. Requires a `renderError` function to customize error message display.

<ArgTypes of={FileUpload.RejectedFile} />


## Examples

### Controlled

The FileUpload component supports both controlled and uncontrolled modes. In controlled mode, you manage the files state externally using the `value` prop and update it via the `onFileChange` callback by extracting `details.acceptedFiles`. This is useful when you need to synchronize the file list with external state management, form libraries, or when you want to programmatically control the files.

<Canvas of={stories.Controlled} />

### With default files

Use the `defaultValue` prop to initialize the component with existing files. This is useful when editing a form with previously uploaded files or when restoring files from a saved state.

<Canvas of={stories.WithDefaultFiles} />

### Single file

Use the `multiple={false}` prop to allow only a single file to be selected. When a new file is selected, it will replace the existing file.

<Canvas of={stories.SingleFile} />



### Error Handling

The FileUpload component provides comprehensive validation and error handling capabilities. You can set various constraints and handle different types of validation errors:

**Built-in Validation Props:**

- `maxFiles` - Maximum number of files allowed
- `maxFileSize` - Maximum file size in bytes
- `minFileSize` - Minimum file size in bytes
- `accept` - Allowed MIME types or file extensions

**Built-in Error Types:**

- `TOO_MANY_FILES` - Exceeds maxFiles limit
- `FILE_INVALID_TYPE` - File type not in accept list
- `FILE_TOO_LARGE` - File size exceeds maxFileSize
- `FILE_TOO_SMALL` - File size below minFileSize
- `FILE_INVALID` - Generic validation failure
- `FILE_EXISTS` - Duplicate file detected

You can use the `FILE_UPLOAD_ERRORS` constant object to reference these error codes in your code instead of using string literals:

```tsx
import { FileUpload, FILE_UPLOAD_ERRORS } from '@spark-ui/components/file-upload'

const errorMessages = {
  [FILE_UPLOAD_ERRORS.TOO_MANY_FILES]: 'Too many files selected',
  [FILE_UPLOAD_ERRORS.FILE_INVALID_TYPE]: 'Invalid file type',
  [FILE_UPLOAD_ERRORS.FILE_TOO_LARGE]: 'File too large',
  [FILE_UPLOAD_ERRORS.FILE_TOO_SMALL]: 'File too small',
  [FILE_UPLOAD_ERRORS.FILE_INVALID]: 'Invalid file',
  [FILE_UPLOAD_ERRORS.FILE_EXISTS]: 'File already exists',
}
```

Use `FileUpload.Context` to access `acceptedFiles` and `rejectedFiles`, then use `FileUpload.AcceptedFile` and `FileUpload.RejectedFile` components to display files with their validation errors. Each rejected file can have multiple error codes, allowing you to show all validation issues at once.

<Canvas of={stories.ErrorHandling} />

### Disabled state

Use the `disabled` prop to prevent user interaction with the file upload component. When disabled, users cannot add, remove, or modify files. The component is visually disabled with reduced opacity and a "not-allowed" cursor. Existing files are still displayed but cannot be modified. Disabled fields do not participate in form submission.

<Canvas of={stories.Disabled} />

### Read-only state

Use the `readOnly` prop to set the file upload to read-only mode. Similar to disabled, users cannot add, remove, or modify files, but the component maintains a more subtle visual appearance (no opacity reduction). Existing files are displayed but cannot be modified. Read-only fields participate in form submission.

<Canvas of={stories.ReadOnly} />

### Upload progress

Use the `uploadProgress` prop on `FileUpload.AcceptedFile` to display a progress bar during file upload. The progress value should be between 0 and 100. The progress bar is displayed at the bottom of the file item container.

<Canvas of={stories.WithProgress} />

## Advanced examples

### Custom Trigger

Use `unstyled` on the `FileUpload.Trigger` and the `render` prop (or a Spark UI component that supports `render`) to render the trigger as a different component.

<Callout kind="warning" marginY="large">
  <p>
    a11y: It is important that the trigger remain a button (with `type="button"`) and that it is focusable and clickable.
  </p>
</Callout>

<Canvas of={stories.CustomTrigger} />

### Custom Dropzone

Customize the dropzone appearance and behavior by wrapping it with other components or modifying its content. This example demonstrates the use of sub-components such as `FileUpload.PreviewImage` to display image previews and `FileUpload.ItemDeleteTrigger` to add a delete button. You can also use `FileUpload.RejectedFileDeleteTrigger` for rejected files.

<Canvas of={stories.CustomDropzone} />

### Custom files preview

Use `FileUpload.Context` to access `acceptedFiles` and customize the markup of the files previews. Several components are available to help you build custom previews:

- **`FileUpload.PreviewImage`** - Displays an image preview for image files, with automatic fallback for non-image files or when preview fails
- **`FileUpload.ItemDeleteTrigger`** - Provides a delete button for accepted files with proper focus management
- **`FileUpload.RejectedFileDeleteTrigger`** - Provides a delete button for rejected files with proper focus management

<Canvas of={stories.WithCustomFileRender} />

### Sortable files

You can make the file previews sortable using drag and drop. This example uses the [`useSortableList`](/docs/hooks-usesortablelist--docs) hook to implement drag and drop reordering with the HTML5 Drag and Drop API. The component uses controlled mode to manage the file order state, allowing users to reorder files by dragging them.

The implementation includes:
- Drag and drop reordering with visual feedback (opacity change during drag)
- Keyboard navigation support (Arrow Up/Down keys to reorder)
- Controlled mode to keep the file order synchronized with external state

<Canvas of={stories.Sortable} />


## Form field

When using the `FileUpload` component you might want to use it in combination with `FormField` to add a proper label, error message, etc.

### Label

Use `FormField.Label` to add a label to the file upload. The label provides visual context and can display the required indicator.

<Callout kind="info">
  **Note**: Unlike other form components, the `FormField.Label` is not automatically linked to the trigger button or dropzone via `aria-labelledby`. The accessible name of the button/dropzone remains their natural text content. The label is still useful for visual consistency, required indicators, and form structure.
</Callout>

<Canvas of={stories.FieldLabel} />

### Required

Use the `isRequired` prop of the `FormField` to indicate that the file upload is required.

<Callout kind="warning">
  If your form has mandatory fields, you must include an explicit note at the top of the form, outside of the input fields, to inform users that certain fields are required.
</Callout>

<Canvas of={stories.FieldRequired} />

### Helper message

Use the `FormField.HelperMessage` component to provide a description to the file upload.

<Canvas of={stories.FieldHelperMessage} />

### Validation

Set the `state` prop of the `FormField` to `error` to indicate that the file upload is invalid. Optionally use the `FormField.ErrorMessage` to describe why the file upload is invalid.

<Canvas of={stories.FieldInvalid} />

## Accessibility

<A11yReport of="file-upload" />

Adheres to the [file upload pattern](https://www.w3.org/WAI/ARIA/apg/patterns/file-upload/).

### Keyboard Interactions

- <kbd>Tab</kbd> - Navigate to the file upload trigger
- <kbd>Enter</kbd> or <kbd>Space</kbd> - Open file selection dialog
- <kbd>Escape</kbd> - Close file selection dialog

### Pattern

The FileUpload component uses a context-based architecture where the main component provides file management state and the sub-components handle specific functionality like triggering file selection and displaying file previews.

